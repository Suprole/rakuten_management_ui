{"version":3,"sources":["../../../lib/snapshot.ts"],"sourcesContent":["export type SnapshotRow = Record<string, unknown>\n\nexport interface Snapshot {\n  generated_at: string\n  products: SnapshotRow[]\n  skus: SnapshotRow[]\n  notes: SnapshotRow[]\n  settings: SnapshotRow[]\n}\n\nconst SNAPSHOT_URL = process.env.SNAPSHOT_URL\nconst SNAPSHOT_GCS_BUCKET = process.env.SNAPSHOT_GCS_BUCKET\nconst SNAPSHOT_GCS_OBJECT = process.env.SNAPSHOT_GCS_OBJECT ?? \"snapshot.json\"\nconst GCP_SERVICE_ACCOUNT_KEY = process.env.GCP_SERVICE_ACCOUNT_KEY\n\ntype ServiceAccountKey = {\n  project_id?: string\n  client_email?: string\n  private_key?: string\n}\n\nasync function fetchSnapshotFromGcs(): Promise<Snapshot> {\n  if (!SNAPSHOT_GCS_BUCKET) throw new Error(\"Missing env var: SNAPSHOT_GCS_BUCKET\")\n  if (!GCP_SERVICE_ACCOUNT_KEY) throw new Error(\"Missing env var: GCP_SERVICE_ACCOUNT_KEY\")\n\n  let key: ServiceAccountKey\n  try {\n    key = JSON.parse(GCP_SERVICE_ACCOUNT_KEY) as ServiceAccountKey\n  } catch {\n    throw new Error(\"Invalid JSON in env var: GCP_SERVICE_ACCOUNT_KEY\")\n  }\n\n  const { Storage } = await import(\"@google-cloud/storage\")\n  const storage = new Storage({\n    projectId: key.project_id,\n    credentials: {\n      client_email: key.client_email,\n      private_key: key.private_key,\n    },\n  })\n\n  const [buf] = await storage.bucket(SNAPSHOT_GCS_BUCKET).file(SNAPSHOT_GCS_OBJECT).download()\n  return JSON.parse(buf.toString(\"utf-8\")) as Snapshot\n}\n\nexport async function fetchSnapshot(options?: { revalidate?: number; cache?: RequestCache }): Promise<Snapshot> {\n  // 優先順位:\n  // 1) SNAPSHOT_URL（公開/社内URLなどでHTTP取得）\n  // 2) 非公開GCS（サービスアカウントで取得）: SNAPSHOT_GCS_BUCKET + GCP_SERVICE_ACCOUNT_KEY\n  if (!SNAPSHOT_URL) {\n    return await fetchSnapshotFromGcs()\n  }\n\n  const revalidate = options?.revalidate ?? 3600\n  const cache = options?.cache\n\n  const res = await fetch(SNAPSHOT_URL, {\n    // 更新頻度: 60分（要件）。ただしnotes等は no-store で即時反映させることがある。\n    ...(cache ? { cache } : { next: { revalidate } }),\n    headers: { accept: \"application/json\" },\n  })\n\n  if (!res.ok) {\n    throw new Error(`SNAPSHOT_URL fetch failed: ${res.status} ${res.statusText}`)\n  }\n\n  return (await res.json()) as Snapshot\n}\n\nexport function asString(v: unknown): string {\n  return typeof v === \"string\" ? v : v == null ? \"\" : String(v)\n}\n\nexport function asNumber(v: unknown): number {\n  if (typeof v === \"number\") return Number.isFinite(v) ? v : 0\n  const n = Number(asString(v).replace(/[¥,%\\s]/g, \"\").replace(/,/g, \"\"))\n  return Number.isFinite(n) ? n : 0\n}\n\nexport function safeJsonArray(v: unknown): string[] {\n  if (Array.isArray(v)) return v.map((x) => asString(x)).filter(Boolean)\n  if (typeof v !== \"string\") return []\n  try {\n    const parsed = JSON.parse(v)\n    return Array.isArray(parsed) ? parsed.map((x) => asString(x)).filter(Boolean) : []\n  } catch {\n    return []\n  }\n}\n\nexport function settingsToMap(settingsRows: SnapshotRow[]): Record<string, unknown> {\n  const out: Record<string, unknown> = {}\n  for (const row of settingsRows) {\n    const key = asString(row[\"key\"]).trim()\n    if (!key) continue\n    out[key] = row[\"value\"]\n  }\n  return out\n}\n\n\n"],"names":[],"mappings":"uCAUA,IAAM,EAAe,QAAQ,GAAG,CAAC,YAAY,CACvC,EAAsB,QAAQ,GAAG,CAAC,mBAAmB,CACrD,EAAsB,QAAQ,GAAG,CAAC,mBAAmB,EAAI,gBACzD,EAA0B,QAAQ,GAAG,CAAC,uBAAuB,CAQnE,eAAe,QAIT,EAHJ,GAAI,CAAC,EAAqB,MAAM,AAAI,MAAM,wCAC1C,GAAI,CAAC,EAAyB,MAAM,AAAI,MAAM,4CAG9C,GAAI,CACF,EAAM,KAAK,KAAK,CAAC,EACnB,CAAE,KAAM,CACN,MAAM,AAAI,MAAM,mDAClB,CAEA,GAAM,CAAE,SAAO,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OACd,EAAU,IAAI,EAAQ,CAC1B,UAAW,EAAI,UAAU,CACzB,YAAa,CACX,aAAc,EAAI,YAAY,CAC9B,YAAa,EAAI,WAAW,AAC9B,CACF,GAEM,CAAC,EAAI,CAAG,MAAM,EAAQ,MAAM,CAAC,GAAqB,IAAI,CAAC,GAAqB,QAAQ,GAC1F,OAAO,KAAK,KAAK,CAAC,EAAI,QAAQ,CAAC,SACjC,CAEO,eAAe,EAAc,CAAuD,EAIzF,GAAI,CAAC,EACH,OAAO,KADU,CACJ,IAGf,IAAM,EAAa,GAAS,YAAc,KACpC,EAAQ,GAAS,MAEjB,EAAM,MAAM,MAAM,EAAc,CAEpC,GAAI,EAAQ,OAAE,CAAM,EAAI,CAAE,KAAM,YAAE,CAAW,CAAE,CAAC,CAChD,QAAS,CAAE,OAAQ,kBAAmB,CACxC,GAEA,GAAI,CAAC,EAAI,EAAE,CACT,CADW,KACL,AAAI,MAAM,CAAC,2BAA2B,EAAE,EAAI,MAAM,CAAC,CAAC,EAAE,EAAI,UAAU,CAAA,CAAE,EAG9E,OAAQ,MAAM,EAAI,IAAI,EACxB,CAEO,SAAS,EAAS,CAAU,EACjC,MAAoB,AAAb,iBAAO,EAAiB,EAAS,MAAL,EAAY,GAAK,OAAO,EAC7D,CAEO,SAAS,EAAS,CAAU,EACjC,GAAiB,UAAb,OAAO,EAAgB,OAAO,OAAO,QAAQ,CAAC,GAAK,EAAI,EAC3D,IAAM,EAAI,OAAO,EAAS,GAAG,OAAO,CAAC,WAAY,IAAI,OAAO,CAAC,KAAM,KACnE,OAAO,OAAO,QAAQ,CAAC,GAAK,EAAI,CAClC,CAEO,SAAS,EAAc,CAAU,EACtC,GAAI,MAAM,OAAO,CAAC,GAAI,OAAO,EAAE,GAAG,CAAC,AAAC,GAAM,EAAS,IAAI,MAAM,CAAC,SAC9D,GAAI,AAAa,iBAAN,EAAgB,MAAO,EAAE,CACpC,GAAI,CACF,IAAM,EAAS,KAAK,KAAK,CAAC,GAC1B,OAAO,MAAM,OAAO,CAAC,GAAU,EAAO,GAAG,CAAC,AAAC,GAAM,EAAS,IAAI,MAAM,CAAC,SAAW,EAAE,AACpF,CAAE,KAAM,CACN,MAAO,EAAE,AACX,CACF,CAEO,SAAS,EAAc,CAA2B,EACvD,IAAM,EAA+B,CAAC,EACtC,IAAK,IAAM,KAAO,EAAc,CAC9B,IAAM,EAAM,EAAS,EAAI,CAAD,EAAO,EAAE,IAAI,GAChC,IACL,CADU,AACP,CAAC,EAAI,CAAG,EAAI,CAAD,IAAC,AAAQ,CACzB,CACA,OAAO,CACT"}