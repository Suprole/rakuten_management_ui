{"version":3,"sources":["../../../lib/snapshot.ts"],"sourcesContent":["export type SnapshotRow = Record<string, unknown>\n\nexport interface Snapshot {\n  generated_at: string\n  products: SnapshotRow[]\n  skus: SnapshotRow[]\n  notes: SnapshotRow[]\n  settings: SnapshotRow[]\n}\n\nconst SNAPSHOT_URL = process.env.SNAPSHOT_URL\n\nexport async function fetchSnapshot(): Promise<Snapshot> {\n  if (!SNAPSHOT_URL) {\n    throw new Error(\"Missing env var: SNAPSHOT_URL\")\n  }\n\n  const res = await fetch(SNAPSHOT_URL, {\n    // 更新頻度: 60分（要件）\n    next: { revalidate: 3600 },\n    headers: { accept: \"application/json\" },\n  })\n\n  if (!res.ok) {\n    throw new Error(`SNAPSHOT_URL fetch failed: ${res.status} ${res.statusText}`)\n  }\n\n  return (await res.json()) as Snapshot\n}\n\nexport function asString(v: unknown): string {\n  return typeof v === \"string\" ? v : v == null ? \"\" : String(v)\n}\n\nexport function asNumber(v: unknown): number {\n  if (typeof v === \"number\") return Number.isFinite(v) ? v : 0\n  const n = Number(asString(v).replace(/[¥,%\\s]/g, \"\").replace(/,/g, \"\"))\n  return Number.isFinite(n) ? n : 0\n}\n\nexport function safeJsonArray(v: unknown): string[] {\n  if (Array.isArray(v)) return v.map((x) => asString(x)).filter(Boolean)\n  if (typeof v !== \"string\") return []\n  try {\n    const parsed = JSON.parse(v)\n    return Array.isArray(parsed) ? parsed.map((x) => asString(x)).filter(Boolean) : []\n  } catch {\n    return []\n  }\n}\n\nexport function settingsToMap(settingsRows: SnapshotRow[]): Record<string, unknown> {\n  const out: Record<string, unknown> = {}\n  for (const row of settingsRows) {\n    const key = asString(row[\"key\"]).trim()\n    if (!key) continue\n    out[key] = row[\"value\"]\n  }\n  return out\n}\n\n\n"],"names":[],"mappings":"uCAUA,IAAM,EAAe,QAAQ,GAAG,CAAC,YAAY,CAEtC,eAAe,IACpB,GAAI,CAAC,EACH,MAAM,AAAI,MADO,AACD,iCAGlB,IAAM,EAAM,MAAM,MAAM,EAAc,CAEpC,KAAM,CAAE,WAAY,IAAK,EACzB,QAAS,CAAE,OAAQ,kBAAmB,CACxC,GAEA,GAAI,CAAC,EAAI,EAAE,CACT,CADW,KACL,AAAI,MAAM,CAAC,2BAA2B,EAAE,EAAI,MAAM,CAAC,CAAC,EAAE,EAAI,UAAU,CAAA,CAAE,EAG9E,OAAQ,MAAM,EAAI,IAAI,EACxB,CAEO,SAAS,EAAS,CAAU,EACjC,MAAoB,UAAb,OAAO,EAAiB,EAAS,MAAL,EAAY,GAAK,OAAO,EAC7D,CAEO,SAAS,EAAS,CAAU,EACjC,GAAiB,UAAb,OAAO,EAAgB,OAAO,OAAO,QAAQ,CAAC,GAAK,EAAI,EAC3D,IAAM,EAAI,OAAO,EAAS,GAAG,OAAO,CAAC,WAAY,IAAI,OAAO,CAAC,KAAM,KACnE,OAAO,OAAO,QAAQ,CAAC,GAAK,EAAI,CAClC,CAEO,SAAS,EAAc,CAAU,EACtC,GAAI,MAAM,OAAO,CAAC,GAAI,OAAO,EAAE,GAAG,CAAC,AAAC,GAAM,EAAS,IAAI,MAAM,CAAC,SAC9D,GAAiB,UAAb,OAAO,EAAgB,MAAO,EAAE,CACpC,GAAI,CACF,IAAM,EAAS,KAAK,KAAK,CAAC,GAC1B,OAAO,MAAM,OAAO,CAAC,GAAU,EAAO,GAAG,CAAC,AAAC,GAAM,EAAS,IAAI,MAAM,CAAC,SAAW,EAClF,AADoF,CAClF,KAAM,CACN,MAAO,EAAE,AACX,CACF,CAEO,SAAS,EAAc,CAA2B,EACvD,IAAM,EAA+B,CAAC,EACtC,IAAK,IAAM,KAAO,EAAc,CAC9B,IAAM,EAAM,EAAS,EAAI,CAAD,EAAO,EAAE,IAAI,GAChC,IACL,CADU,AACP,CAAC,EAAI,CAAG,EAAI,CAAD,IAAC,AAAQ,CACzB,CACA,OAAO,CACT"}