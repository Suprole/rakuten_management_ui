# データ接続方式（最速表示優先）

## 結論（採用方針）

**「GASで事前集計→JSONスナップショット化→Next.js APIが強キャッシュして配信」**を採用します。

- **表示/処理速度が最優先**のため、リクエスト毎にGoogle Sheetsを読み取りません
- UI側ではバッジ等の重い計算をしません（**GASが事前生成**）
- 画面アクセスは `middleware.ts` により **Google OAuth + 許可メールのみ**に制限されます

## データの流れ

1. **Google Sheets（raw）** にRMS/TSV貼り付け
2. **GAS** が仕様書どおりに集約し、以下のcacheシートを全置換生成
   - `webui_products_cache`（一覧/詳細の参照元）
   - `webui_skus_cache`（SKU内訳）
   - `settings`（送料/率/閾値）
   - `product_notes`（編集永続）
3. GASが上記を **JSONへスナップショット出力**（推奨: 1ファイル or 4ファイル）
4. Next.js（本リポジトリ）が、そのJSONを **サーバ側で取得してキャッシュ**し、`/api/*` として配信

## JSONスナップショットの置き場所（推奨順）

- **推奨A（最速・安定）**: Google Cloud Storage（GCS）に配置し、CDN/キャッシュを効かせる
- **推奨B（簡易）**: Google Drive にJSONファイルを保存し、Next.jsが取得（認可/共有設定が必要）
- **推奨C（簡易）**: Apps Script WebアプリがJSONを返す（トラフィック増で不利になりがち）

## Next.js側のキャッシュ戦略

- Next.js Route Handler で **`revalidate`** を設定し、一定間隔でのみ更新
  - 例: `export const revalidate = 60`（60秒ごと更新）
- さらに必要なら **`unstable_cache`** を併用してサーバ内キャッシュも強化

## product_notes（評価・メモ）の最速運用

一覧・詳細の読み取り性能を落とさないため、**読み取りはGCSのスナップショット**を参照し、**保存はGAS WebAppへ直接書き込み→直後にsnapshot再出力**します。

- Next.js（環境変数）
  - `SNAPSHOT_URL`: `snapshot.json` の公開URL（CDN/強キャッシュ推奨）
  - `NOTES_WEBAPP_URL`: GAS WebApp のURL
  - `NOTES_WEBAPP_TOKEN`: GAS WebApp への書き込み用トークン
- GAS（Script Properties）
  - `WEBAPP_TOKEN`: `NOTES_WEBAPP_TOKEN` と同値

この方式により、保存直後も読み取りはスナップショット（速い経路）に寄せたまま「即時反映」を実現します。

## バッジ生成（速度優先）

バッジは **GAS側で事前生成**し、`webui_products_cache.badges` に入れて配信します。

- UIは **配列を表示するだけ**
- 閾値は `settings` で変更可能にし、変更時はGAS側で再生成（もしくは次回定期生成で反映）


