# システム完成までのタスクリスト（楽天市場 商品可視化 WebUI）

前提:
- 仕様書: `仕様書.md`
- リポジトリ構成:
  - `frontend/` = Next.js（WebUI）
  - `gas/` = Google Apps Script（raw→web用cache生成、JSONスナップショット出力）
- 方針:
  - **速度最優先**: GASで事前集計・事前バッジ生成 → JSONスナップショット → Next.js APIが強キャッシュ配信
  - 認証: **Google OAuth2.0 + 許可メールアドレスのみ閲覧**
  - 商品評価: **S/A/B/C/D/E** を採用

---

## 0. 合意/設計の確定（最初に決める）

- [ ] **データ更新頻度**を確定（例: 5分/15分/1時間、手動トリガー併用など）
- [ ] **JSONスナップショットの置き場所**を確定（推奨: GCS、次点: Drive、簡易: GAS WebApp）
- [ ] **settingsの変更反映**を確定（変更時にGAS再生成 or 次回定期生成で反映）
- [ ] **許可メールの管理方法**を確定（環境変数 `ALLOWED_EMAILS` の運用/更新手順）

---

## 1. GAS（raw → web用cache生成）実装（必須）

### 1.1 シート構成の作成/確認（仕様書 §6）
- [ ] rawシート（商品一元管理）を読み取り対象として確定（WebUIは直接参照しない）
- [ ] `webui_products_cache` を作成（列は仕様書 §6.2 の全列必須）
- [ ] `webui_skus_cache` を作成（仕様書 §6.3）
- [ ] `product_notes` を作成（仕様書 §6.4）
- [ ] `settings` を作成（仕様書 §6.5）

### 1.2 正規化（仕様書 §11）
- [ ] 数値正規化（`¥`, `%`, カンマ等の除去、空/文字列混入の扱い）
- [ ] `setValues` による一括書き込み（行単位ループ禁止）
- [ ] cache生成は**全置換**（差分更新ではなく置換）

### 1.3 集約ロジック（仕様書 §7）
- [ ] groupby: key=`product_code`
- [ ] SKU合算: `stock_sum`, `sales_units_m/lm`, `sales_amount_m/lm`, `profit_m/lm`
- [ ] 代表値採用（先頭非空）: `access_*`, `cv_*`, `bounce_*`, `stay_*`, `fav_*`, `reviews_total` など
- [ ] 代表SKU: 「今月売上個数最大のSKU」or 全て0/空なら先頭SKU
- [ ] 利益率系: `min_setting_margin`, `max_setting_margin` をSKU最小/最大で算出
- [ ] diff系: `access_diff`, `cv_diff`, `sales_units_diff`, `profit_diff` を算出
- [ ] 新規/リピ比率: `new_ratio_m`, `rep_ratio_m` を算出

### 1.4 バッジ生成（速度優先）
- [ ] `settings` の閾値JSONを定義（例: 低在庫、アクセス上位%、低利益率など）
- [ ] `webui_products_cache.badges` を **配列→JSON文字列** で生成（仕様書に合わせる）
- [ ] バッジ「最大3つ表示 + 残り+ n」はWebUI側表示仕様として維持（生成側は全件保持）

### 1.5 `product_notes`（編集永続）
- [ ] `product_notes` の読み取り（cache再生成に影響されない）
- [ ] `product_notes` の書き込み（`updated_at` 更新）
- [ ] rating（S〜E）と memo のスキーマ確定・バリデーション

### 1.6 JSONスナップショット出力（速度最優先の肝）
- [ ] `webui_products_cache` をJSONにエクスポート
- [ ] `webui_skus_cache` をJSONにエクスポート
- [ ] `settings` をJSONにエクスポート
- [ ] `product_notes` をJSONにエクスポート（もしくはWebUI更新は別経路でも可）
- [ ] 出力先（GCS/Drive/WebApp）に合わせて認可・公開範囲・URL設計を実装
- [ ] トリガー設定（定期 + 手動）

成果物（GAS側）:
- [ ] `gas/` 配下にソース一式（スクリプト、導入手順、シート初期化手順）

---

## 2. Frontend（Next.js）実装（必須）

### 2.1 認証（Google OAuth2.0 + 許可メール）
- [ ] Google Cloud側設定（OAuth同意画面、リダイレクトURI）
- [ ] `AUTH_SECRET`, `AUTH_GOOGLE_ID`, `AUTH_GOOGLE_SECRET`, `ALLOWED_EMAILS` の運用確立
- [ ] 未許可メールのUX（ログイン不可メッセージ/問い合わせ導線）
- [ ] セッション期限/ログアウト動線

### 2.2 API（/api/*）を「実データ + 強キャッシュ」に置換
現状は雛形/モックなので、以下を実装して差し替える。

- [ ] `/api/products`（一覧・詳細元）
  - [ ] JSONスナップショットから取得
  - [ ] `revalidate`/サーバ内キャッシュで高速化
  - [ ] `badges`（JSON文字列→配列）を整形して返す（フロントが表示しやすい形）
- [ ] `/api/skus?product_code=...`（SKU内訳）
- [ ] `/api/settings`（送料/率/閾値）
- [ ] `/api/notes`（評価・メモ）
  - [ ] 「notesはSheets直書き or notesだけ別ストレージ」など方針を確定して実装

### 2.3 型定義（仕様準拠）
- [ ] `ProductSummary` / `ProductDetail` を仕様書の列と整合させる（不足/過剰フィールドの整理）
- [ ] `rating` は S〜E として統一（済）
- [ ] 数値・null・未定義の扱いを統一（表示/計算の安全性）

### 2.4 UI（一覧画面 仕様書 §8）
- [ ] 一覧の参照元を `/api/products` に切替（モック撤去）
- [ ] 表示列が仕様書どおりであることを最終確認
- [ ] バッジ表示（最大3 + `+n`）を最終確認
- [ ] 大量データ時の対策（ページング or 仮想化 or サーバ側検索）を決定・実装

### 2.5 UI（詳細画面 仕様書 §9）
- [ ] 先月vs今月比較を **実データ** で表示（売上/利益/売上個数/利益率/新規リピ/アクセス/CV/お気に入り/レビュー）
- [ ] SKU内訳テーブルを **`/api/skus`** から表示
- [ ] 評価・メモを **`/api/notes`** と同期（楽観更新＋失敗時復旧）
- [ ] `note_updated_at` を表示

### 2.6 利益シミュレーター（仕様書 §10）
- [ ] 送料を `shipping_type` 選択→ `settings.shipping_cost_in_tax` 参照に変更（現状は数値入力）
- [ ] `tax_rate`, `fee_rate`, `default_point_rate` を `settings` 参照に変更（現状固定）
- [ ] 入力バリデーション（負数/空/NaN）

---

## 3. Settings 管理（運用成立のため）

- [ ] `settings` の編集手段を決定
  - [ ] シートで手編集（最短） or WebUIに設定画面を追加（将来）
- [ ] 閾値変更時の再生成運用を整備（バッジ含む）
- [ ] 設定変更の監査（必要なら、更新者/更新日時ログ）

---

## 4. 非機能（安定運用）

### 4.1 パフォーマンス
- [ ] JSONスナップショットのサイズ見積り（件数×SKU）
- [ ] APIレスポンスを圧縮/キャッシュ最適化（CDNキャッシュ含む）
- [ ] フロントの初期ロード最適化（必要ならSSR/Streaming/分割）

### 4.2 エラーハンドリング/可観測性
- [ ] API失敗時の表示（再試行、フォールバック）
- [ ] GAS実行失敗時の通知（メール/Slack等）
- [ ] バージョニング（スナップショットの世代管理、ロールバック）

### 4.3 セキュリティ
- [ ] 許可メールの管理（漏洩/誤設定時の対処）
- [ ] JSONスナップショットの公開範囲（原則: 非公開/署名URL/認可）
- [ ] 重要情報は環境変数へ（Secretsの取り扱い）

---

## 5. リリース手順（完成の定義）

- [ ] 本番環境（例: Vercel）に `frontend/` をデプロイ
- [ ] OAuthリダイレクトURIを本番ドメインで設定
- [ ] GASトリガーを本番スプレッドシートに設定
- [ ] 初回スナップショット生成 → WebUI表示確認
- [ ] 代表的な商品で「一覧→詳細→メモ保存→再読込」動作確認
- [ ] 仕様書の表示列/計算式/バッジ表示ルールの最終チェック

---

## 6. 受け入れチェック（最終確認）

- [ ] 一覧が商品粒度で正しく集約されている（アクセス水増しが無い）
- [ ] SKU内訳が一致している（在庫/売上/利益）
- [ ] `product_notes` がcache再生成の影響を受けない
- [ ] `settings` 変更が運用ルールどおりに反映される
- [ ] 許可メール以外が閲覧できない（ログイン/直URL/APIアクセス）


